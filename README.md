# SS Prompt Manager

## プロジェクト概要
- **名称**: SS Prompt Manager
- **目標**: 自然言語やキーワードから、各画像生成モデル（SDXL/Flux/ImageFX）に最適化されたプロンプトを生成し、英日バイリンガル編集UIで調整できるWebアプリ
- **主要機能**: 
  - OpenRouter.ai APIによる最新AIモデルの利用
  - 英日バイリンガルタグ編集（リアルタイム同期・翻訳）
  - AI駆動のプロンプト最適化と自動カテゴリ分類
  - 複数出力形式対応（SDXL、Flux、ImageFX、カスタム）
  - ドラッグ＆ドロップによるタグ順序変更
  - 重み調整機能（0.1〜2.0）
  - バッチ処理機能

## URL
- **開発環境**: https://3000-icbwmbmktn0pgobop47sb-6532622b.e2b.dev
- **GitHub**: https://github.com/ssspace1/ss-prompt-manager-V2.1
- **本番環境**: 未デプロイ（Cloudflare Pages予定）
- **ヘルスチェック**: https://3000-icbwmbmktn0pgobop47sb-6532622b.e2b.dev/api/health

## 🎉 最新アップデート (2025-08-22 23:45)

### 🎯 UI最適化 - Image to Promptタブのコンパクト化 (IMPROVED!)

#### 📎 スペース効率の大幅改善
- **空白エリア削除**: 不要な空白を除去してコンテンツ表示量を最大化
- **コントロールのコンパクト化**: ボタンとセレクトボックスのサイズを最適化
- **画像ドロップゾーン**: 48rem → 32remに縮小
- **タグエディタ高さ**: max-h-96 → max-h-64に調整
- **AI分析結果**: max-h-40 → max-h-32に変更
- **ボタンパディング**: py-2 → py-1.5、px-4 → px-3に縮小

#### ✨ 新機能
- **AI Analysisトグルボタン**: 分析結果の表示/非表示を切り替え
- **ソート機能**: カテゴリ別/重み別にタグを並び替え

### 🎆 画像解析システムプロンプトの編集機能追加

#### ⚙️ Settings → Image Analysis タブで完全カスタマイズ
- **画像解析プロンプト編集**: 画像から何を抽出するか、どう分析するかを自由に定義
- **タグ生成プロンプト編集**: フォーマット別（SDXL/Flux/ImageFX）にタグ生成ルールをカスタマイズ
- **Vision Model選択**: Gemini 2.0 Flash Exp、GPT-4o、Claude 3.5 Sonnetなどから選択可能
- **デフォルトに戻す**: ワンクリックで初期設定にリセット
- **保存機能**: 全ての設定はLocalStorageに永続化

#### 📝 システムプロンプトカスタマイズ例
```
# 画像解析プロンプト例
- 人物の感情や表情を重点的に分析
- 背景の雰囲気やムードを詳細に記述
- アートスタイルや技法を特定

# タグ生成プロンプト例
- より短く簡潔なタグを生成
- 特定のジャンルに特化したタグ作成
- 重要度の自動調整ルール追加
```

### Image to Prompt 完全実装 - 画像解析からタグ生成まで統合ワークフロー 🎨

#### 🔥 画像解析→タグ生成の一括処理実装
- **AI Generate ワンクリック処理**: 画像アップロード → 解析 → タグ生成 → 日本語化を一連で自動実行
- **2段階システムプロンプト**: 
  1. 画像解析用プロンプト（カスタマイズ可能）
  2. タグ生成用プロンプト（フォーマット別設定可能）
- **Vision API 統合**: Gemini 2.0 Flash Exp をデフォルト、他のVisionモデルも選択可能
- **JSONスキーマ準拠**: 構造化されたタグ生成で確実な英日対訳ペア作成

#### ✨ Image タブの機能完全実装
- **Split to Tags**: 生成されたプロンプトをカンマ・ピリオドで機械的分割
- **Add New Tag**: 英語/日本語どちらからでも新規タグ追加（自動翻訳付き）
- **Translate All**: 全タグの一括翻訳（英→日、日→英）
- **タグ編集機能**: Text to Promptと完全に同じTagEditorシステムを共有
- **Final Output**: SDXL/Flux/ImageFX/Custom形式での出力に対応
- **Copy機能**: Final Outputのクリップボードコピー対応

#### 🛠️ システムプロンプトのカスタマイズ機能
- **getImageAnalysisSystemPrompt()**: 画像解析方法を定義するプロンプト
- **getTagGenerationSystemPrompt()**: AI Format用のタグ生成プロンプト
- **LocalStorage保存**: カスタマイズしたプロンプトは永続化
- **フォーマット別設定**: SDXL/Flux/ImageFX/Custom それぞれに異なるプロンプト設定可能

#### 📊 処理フローの詳細
1. **画像アップロード**: ドラッグ&ドロップまたはファイル選択
2. **AI Generate クリック**: 
   - 画像解析（未解析の場合）→ Vision APIで詳細分析
   - タグ生成 → 解析結果から構造化タグを生成
   - 日本語化 → わかりやすい日本語タグを自動生成
3. **タグ編集**: 英日双方向の編集・翻訳・重み調整
4. **出力生成**: 選択したフォーマットで最終プロンプト生成

#### 🐛 バグ修正と改善
- **generateFromImage関数追加**: AI Generateボタンのエントリーポイント実装
- **updateImagePromptOutput実装**: タグ変更時の出力更新処理
- **copyImageFinalOutput追加**: Final Outputのコピー機能
- **エラーメッセージ日本語化**: ユーザーフレンドリーなエラー表示

### UI最適化 - コンテンツ表示量の最大化 📊
- **ドロップゾーンの最小化**: ドラッグ時のドロップゾーンを4pxの細い線に変更
- **ホバー時のみ拡張**: ドロップ位置にホバーした時のみ24pxに拡張、「✓ Drop」の小さな表示
- **アニメーション削減**: ドラッグ時に他のタグが動かないよう、不要なアニメーションを削除
- **ドラッグ効果の最適化**: ドラッグ中のタグのみ縮小（0.98倍）と透明化（40%）
- **画面効率向上**: より多くのタグを同時に表示可能に

### ドラッグ&ドロップ機能の改善と修正 🎯（12:45更新）
- **視覚的フィードバック強化**: ドロップゾーンにアニメーション付きインジケーターを追加
- **ドラッグハンドル追加**: 各タグにグリップアイコンを表示してドラッグ可能であることを明示
- **翻訳機能の統一**: Image to PromptとText to Promptで同じ翻訳メカニズム（translateWithAI/translateToEnglish）を使用
- **バグ修正**: removeImageTag、moveImageTagの関数呼び出しエラーを修正

### Image to Prompt機能の統一化 🔄 (2025-08-22 早朝)
- **Split to Tags機能追加**: 生成されたプロンプトをタグに分割する機能を実装
- **Tag Editor完全統合**: Text to Promptと完全に同じタグ編集システムを共有
- **縦スクロール対応**: タグリストをmax-h-96に統一し、縦スクロールで全タグを閲覧可能
- **カテゴリ分類統一**: 共通のcategorizeTag関数で一貫した分類
- **コード重複削除**: renderImageTagsを削除し、TagEditor.renderTagsに統一
- **AI Generate改善**: より良いタグ形式で生成するようプロンプトを最適化

## 🎉 以前のアップデート (2025-08-22)

### ドラッグ&ドロップ機能の実装 🎨
- **スムーズなドラッグ&ドロップ**: 矢印ボタンを廃止し、直感的なドラッグ操作でタグの順序を変更
- **視覚的フィードバック**: ドラッグ中の回転・スケールアニメーション
- **ドロップ位置インジケーター**: グラデーション付きの光るインジケーターで挿入位置を明示
- **ドラッグハンドル**: ホバーで色が変わるグリップアイコン
- **アニメーション効果**: cubic-bezier関数による滑らかな動き

### Image to Prompt機能の完全実装 📸
- **画像アップロード**: ドラッグ&ドロップまたはファイル選択で画像をアップロード
- **Vision AI分析**: Gemini、GPT-4o、Claude等の最新Vision AIモデルで画像を分析
- **プロンプト生成**: 画像分析結果から最適化されたプロンプトを自動生成
- **統一タグエディター**: Text to Promptと同じタグ編集機能を共有（単一コードベース）
- **コンパクトUI**: 画像と出力を上部に並列配置、AI分析結果は折りたたみ可能

### UI/UXの改善
- **レイアウト最適化**: 画像タブのレイアウトをText to Promptと統一
- **カラーコーディング**: 全タブでカテゴリ別の色分けを実装
- **Final Output統一**: 両タブでFinal Output形式の独立選択が可能

## 現在のAPI URL

### 機能別エントリーポイント
- **メインページ**: `/` - SS Prompt Manager メインUI
- **ヘルスチェック**: `/api/health` - サービス状態確認
- **OpenRouter Models**: `/api/openrouter/models` - 利用可能なAIモデル一覧
- **Chat Completion**: `/api/openrouter/chat` - AIチャット処理
- **翻訳API**: `/api/translate` - テキスト翻訳（英日双方向）
- **プロンプト最適化**: `/api/optimize` - フォーマット別プロンプト最適化
- **タグ生成**: `/api/generate-tags` - 自然言語からタグ生成

## 現在完了している機能

### ✅ 実装済み機能
1. **OpenRouter.ai API統合** ✨
   - 最新モデル一覧の自動取得と表示
   - モデル選択UI（推奨モデルのクイック選択機能付き）
   - APIキーの検証機能
   - 無料モデルの識別表示

2. **プロンプト処理機能** ✨
   - テキスト分解（カンマ、句読点、改行での分割）
   - AI駆動の自動カテゴリ分類（8カテゴリ）
   - AI最適化（SDXL/Flux/ImageFX形式別）
   - カスタムシステムプロンプト編集

3. **バイリンガル編集UI** 🆕 **2025/08/21 AI連携強化！**
   - **英日2カラム表示で完全同期**
   - **AI駆動の高精度翻訳** - OpenRouter APIによる文脈理解型翻訳
   - **リアルタイム双方向翻訳** - 英語を編集→日本語自動更新、日本語を編集→英語自動更新
   - **インライン編集** - タグをクリックして直接編集
   - **包括的な翻訳辞書** - 100以上の画像生成関連単語・フレーズを網羅（フォールバック用）
   - **翻訳キャッシュ** - 一度翻訳した内容は即座に表示
   - **日本語入力対応** - 日本語でタグを追加すると自動で英語に翻訳
   - **分解時自動翻訳** - プロンプト分解時に全タグを自動翻訳
   - **AI生成時自動翻訳** - AI生成されたタグも自動的に日本語化

4. **タグ管理機能**
   - ドラッグ＆ドロップによる順序変更
   - 重み調整（0.1〜2.0、0.05刻み）
   - カテゴリ別色分け表示
   - カテゴリ/重み別ソート
   - タグの追加/削除
   - インライン編集機能

5. **出力フォーマット**
   - SDXL形式（カンマ区切り、重み付き）
   - Flux形式（文章形式）
   - ImageFX形式（命令形式）
   - カスタム形式（ユーザー定義可能）

6. **UI/UX機能**
   - ダークモード対応
   - レスポンシブデザイン
   - クリップボードコピー機能
   - テキストファイルエクスポート
   - 設定の永続化（LocalStorage）

## 🛠️ 使用方法

### 1. APIキーの設定（必須）
1. 右上の「Settings」をクリック
2. [OpenRouter.ai](https://openrouter.ai/)でAPIキーを取得
3. APIキーを入力して「Test API Key」をクリック
4. 成功したらモデル一覧が読み込まれます

### 2. カスタム形式の管理

#### カスタム形式の追加
1. AI Formatドロップダウンの横の「+」ボタンをクリック
2. 形式名を入力（英小文字とハイフンのみ）
3. システムプロンプトを編集して保存

#### カスタム形式の削除
1. Settingsを開く
2. 「Custom Formats」タブを選択
3. 削除したい形式の「Delete」ボタンをクリック
4. 確認ダイアログでOKを選択

#### システムプロンプトの編集
1. 歯車アイコン（⚙）をクリック
2. プロンプトを編集
3. 「Save Prompt」で保存（「Reset to Default」でデフォルトに戻す）

### 3. AI機能の使い方

#### Split to Tags（AI翻訳付き）
1. テキストを入力して「Split to Tags」ボタンをクリック
2. タグが自動分解され、AIで日本語に翻訳されます
3. APIキーがない場合は辞書ベースの翻訳にフォールバック

#### AI Generate（形式別生成）
1. 自然言語でプロンプトを入力
2. 形式（SDXL/Flux/ImageFX）を選択
3. 「AI Generate」ボタンをクリック
4. AIが最適化されたタグを生成し、自動的に日本語にも翻訳

#### インライン編集
1. タグをクリックして直接編集
2. 編集した内容は自動的に他言語に翻訳
3. EnterキーまたはクリックアウトでSave、Escでキャンセル

### 3. 通常の使い方
1. **テキスト入力**: プロンプトやキーワードを入力
2. **タグ生成**: 
   - 「Split to Tags」で分解
   - 「AI Generate」でAI最適化
3. **タグ編集**:
   - 重み調整（+/-ボタン）
   - 順序変更（ドラッグ&ドロップ）
   - 削除（ゴミ箱アイコン）
   - インライン編集（タグをクリック）
4. **出力取得**: 
   - フォーマット選択
   - コピーまたはダウンロード

## 📁 データアーキテクチャ

### Cloudflareベース
- **Runtime**: Cloudflare Workers
- **フレームワーク**: Hono
- **静的ファイル**: Cloudflare Pages
- **将来のデータストレージ**: Cloudflare KV / D1 Database

### APIアーキテクチャ
- **/api/translate** - AI翻訳エンドポイント
- **/api/generate-tags** - タグ生成エンドポイント
- **/api/health** - ヘルスチェック
- **/api/generate-image** - 画像生成（将来実装）

## 🔜 開発予定機能

### ✅ 完了した機能
- ✅ AI翻訳機能の実装
- ✅ タグ生成AIの組み込み
- ✅ インライン編集機能
- ✅ 英日完全同期
- ✅ **画像解析とタグ抽出** - Vision APIによる自動タグ生成
- ✅ **JSON構造化タグ生成** - 英日対訳ペアの自動作成
- ✅ **Split to Tags機械分割** - カンマ・ピリオドでの自動分割
- ✅ **Image to Prompt完全実装** - 画像からプロンプト生成まで一貫したワークフロー
- ✅ **AI Format分離** - Text/Image用AI Formatの完全独立
- ✅ **Custom Format管理** - Text/Image別カスタムフォーマット作成・編集・削除
- ✅ **システムプロンプト編集** - 歯車ボタンでリアルタイム編集
- ✅ **新規フォーマット追加** - プラスボタンで簡単追加

### 短期（1-2週間）
- [ ] 画像生成API統合
- [ ] プロンプトテンプレート機能
- [ ] ユーザー定義の辞書
- [ ] システムプロンプト編集UI

### 中期（1ヶ月）
- [ ] プロンプト履歴機能
- [ ] お気に入り機能
- [ ] インポート/エクスポート機能
- [ ] A/B比較機能

### 長期（2-3ヶ月）
- [ ] ユーザーアカウント機能
- [ ] チーム共有機能
- [ ] APIとして公開
- [ ] モバイルアプリ版

## 📚 技術スタック

### フロントエンド
- **UI**: Vanilla JS + TailwindCSS
- **アイコン**: Font Awesome 6.4.0
- **状態管理**: グローバルAppオブジェクト
- **ビルド**: Vite

### バックエンド
- **フレームワーク**: Hono (Cloudflare Workers)
- **API**: OpenRouter.ai統合
- **言語**: TypeScript
- **ランタイム**: Cloudflare Workers

### 開発環境
- **パッケージマネージャー**: npm
- **プロセス管理**: PM2
- **バージョン管理**: Git
- **ホスティング**: E2B（開発）、Cloudflare Pages（本番予定）

## 🚀 デプロイメント

### ローカル開発
```bash
npm install
npm run build
pm2 start ecosystem.config.cjs
```

### Cloudflare Pages（本番）
```bash
npm run build
npx wrangler pages deploy dist --project-name ss-prompt-manager
```

## 📝 ライセンス
MIT

## 👥 貢献者
- ssspace1

## 📞 サポート
Issues: [GitHub Issues](https://github.com/ssspace1/ss-prompt-manager-V2.1/issues)

---
*Last Updated: 2025-08-22*