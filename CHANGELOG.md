# Changelog

## [2025-08-21] 形式切り替え機能の改善

### 🎯 解決した問題
- **問題**: 形式を切り替えると Final Output が変わってしまう
- **解決**: Final Output と AI生成形式を完全に分離

### ✨ 新機能

#### 1. **独立した形式選択**
- **AI Format**: AI生成時に使用する形式（プロンプト生成方法を決定）
- **Final Output Format**: タグエディターの内容を表示する形式（表示のみ）
- 両者は独立して動作し、相互に影響しない

#### 2. **システムプロンプト編集機能**
- 各形式の横に歯車アイコン（⚙）を配置
- クリックでシステムプロンプト編集モーダルを表示
- ユーザーが独自のタグ生成ルールを定義可能
- デフォルトにリセット機能付き

#### 3. **カスタム形式の追加**
- プラスアイコン（+）でカスタム形式を追加
- ユーザー定義の形式名とプロンプトを設定
- 追加した形式は両方のドロップダウンで選択可能

### 📝 技術的な変更点

#### フロントエンド（app-main.js）
```javascript
// 状態の分離
appState = {
  outputFormat: 'sdxl',        // AI生成用
  finalOutputFormat: 'sdxl',   // 表示用
  systemPrompts: {},           // カスタムプロンプト
  editingPrompt: null         // 編集中のプロンプト
}
```

#### バックエンド（index.tsx）
- `/api/generate-tags` エンドポイントがカスタムシステムプロンプトを受け付けるように拡張
- デフォルトプロンプトとカスタムプロンプトの優先順位を実装

### 🔧 使い方

1. **AI生成形式の選択**
   - 上部の「AI Format」ドロップダウンで選択
   - 歯車アイコンでシステムプロンプトを編集

2. **Final Output形式の選択**
   - Final Outputセクションの「Format」ドロップダウンで選択
   - タグエディターの内容がこの形式で表示される

3. **カスタム形式の追加**
   - プラスアイコンをクリック
   - 形式名を入力（英小文字とハイフンのみ）
   - システムプロンプトを編集

### 📌 デフォルト形式
- **SDXL Tags**: カンマ区切り、重み付き（tag:1.2）
- **Flux Phrases**: 文章形式（. で区切り）
- **ImageFX**: 簡潔な指示形式
- **ImageFX Natural**: 自然な文章形式

### 🚀 今後の拡張予定
- [ ] システムプロンプトのインポート/エクスポート
- [ ] プロンプトテンプレートライブラリ
- [ ] 形式ごとの生成履歴保存