<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SS Prompt Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        [data-category="person"] { background-color: #fef3c7; border-color: #fbbf24; }
        [data-category="appearance"] { background-color: #dbeafe; border-color: #60a5fa; }
        [data-category="clothing"] { background-color: #fce7f3; border-color: #f9a8d4; }
        [data-category="pose"] { background-color: #e9d5ff; border-color: #c084fc; }
        [data-category="background"] { background-color: #d1fae5; border-color: #34d399; }
        [data-category="quality"] { background-color: #fed7aa; border-color: #fb923c; }
        [data-category="style"] { background-color: #fef3c7; border-color: #fde047; }
        [data-category="other"] { background-color: #e5e7eb; border-color: #9ca3af; }
        
        .split-view {
            display: grid;
            grid-template-columns: 1fr min(400px, 30%);
            gap: 1rem;
            height: calc(100vh - 120px);
        }
        
        .block-card {
            transition: all 0.2s ease;
            cursor: move;
            user-select: none;
        }
        
        .block-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <!-- ヘッダー -->
        <header class="bg-white shadow-sm border-b">
            <div class="px-4 py-3 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-800">SS Prompt Manager</h1>
                <button onclick="toggleSettings()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fas fa-cog text-xl"></i>
                </button>
            </div>
        </header>
        
        <!-- タブ -->
        <div class="bg-white border-b px-4">
            <div class="flex gap-4">
                <button onclick="setTab('text')" id="tab-text" class="py-3 px-4 border-b-2 border-blue-500 text-blue-600 transition-colors">
                    <i class="fas fa-file-alt mr-2"></i>text
                </button>
                <button onclick="setTab('image')" id="tab-image" class="py-3 px-4 border-b-2 border-transparent hover:text-gray-600 transition-colors">
                    <i class="fas fa-image mr-2"></i>image
                </button>
            </div>
        </div>
        
        <!-- メインコンテンツ -->
        <div class="p-4" id="content-text">
            <div class="split-view">
                <!-- 左側：メインエリア -->
                <div class="space-y-4">
                    <!-- 入力エリア -->
                    <div class="bg-white rounded-lg p-4 shadow">
                        <textarea id="input-text" placeholder="プロンプトを入力..." 
                            class="w-full h-32 p-3 border rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        
                        <!-- 操作ボタン -->
                        <div class="flex gap-2 mt-3 flex-wrap">
                            <button onclick="splitText()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                                分解
                            </button>
                            <button onclick="colorizeBlocks()" class="px-4 py-2 bg-blue-100 hover:bg-blue-200 rounded-lg transition-colors">
                                <i class="fas fa-palette mr-2"></i>AI色分け
                            </button>
                            <button onclick="clearAll()" class="px-4 py-2 bg-red-100 hover:bg-red-200 rounded-lg transition-colors">
                                クリア
                            </button>
                            
                            <div class="flex items-center gap-2 ml-auto">
                                <select id="output-format" class="px-3 py-2 border rounded-lg">
                                    <option value="sdxl">SDXLタグ形式</option>
                                    <option value="flux">Fluxフレーズ形式</option>
                                    <option value="imagefx">ImageFX形式</option>
                                </select>
                                
                                <select id="model-select" class="px-3 py-2 border rounded-lg">
                                    <option value="gpt-4">GPT-4.0</option>
                                    <option value="gpt-3.5-turbo">GPT-3.5</option>
                                    <option value="claude-3">Claude-3</option>
                                </select>
                                
                                <button onclick="generateAI()" class="px-4 py-2 bg-purple-100 hover:bg-purple-200 rounded-lg transition-colors">
                                    <i class="fas fa-sparkles mr-2"></i>AI生成
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- タグ編集エリア -->
                    <div class="bg-white rounded-lg p-4 shadow">
                        <div class="grid grid-cols-2 gap-4">
                            <!-- 英語カラム -->
                            <div>
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-semibold text-gray-700">English</h3>
                                    <div class="flex gap-2">
                                        <input type="text" id="new-tag-en" placeholder="新しいタグを追加" 
                                            class="px-3 py-1 border rounded-lg text-sm"
                                            onkeydown="if(event.key==='Enter')addNewTag('en')">
                                        <button onclick="addNewTag('en')" class="px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="blocks-en" class="space-y-2 max-h-96 overflow-y-auto"></div>
                            </div>
                            
                            <!-- 日本語カラム -->
                            <div>
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="font-semibold text-gray-700">日本語</h3>
                                    <div class="flex gap-2">
                                        <input type="text" id="new-tag-ja" placeholder="新しいタグを追加" 
                                            class="px-3 py-1 border rounded-lg text-sm"
                                            onkeydown="if(event.key==='Enter')addNewTag('ja')">
                                        <button onclick="addNewTag('ja')" class="px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="blocks-ja" class="space-y-2 max-h-96 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 完成プロンプト -->
                    <div class="bg-white rounded-lg p-4 shadow">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-700">完成プロンプト</h3>
                            <button onclick="copyPrompt()" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-lg">
                                <i class="fas fa-copy mr-2"></i>コピー
                            </button>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg">
                            <pre id="final-prompt" class="whitespace-pre-wrap text-sm font-mono">プロンプトがまだ生成されていません</pre>
                        </div>
                    </div>
                </div>
                
                <!-- 右側：画像生成エリア -->
                <div class="bg-white rounded-lg p-4 shadow">
                    <h3 class="font-semibold text-gray-700 mb-3">画像生成</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">プロンプト</label>
                            <div id="preview-prompt" class="p-2 bg-gray-50 rounded text-sm max-h-32 overflow-y-auto">
                                プロンプトなし
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">モデル</label>
                            <select class="w-full px-3 py-2 border rounded-lg">
                                <option>SDXL 1.0</option>
                                <option>Flux.1 Dev</option>
                                <option>Midjourney v6</option>
                            </select>
                        </div>
                        
                        <button onclick="generateImage()" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            <i class="fas fa-sparkles mr-2"></i>生成
                        </button>
                        
                        <div id="generated-image" class="mt-4"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="p-4 hidden" id="content-image">
            <div class="bg-white rounded-lg p-8 text-center">
                <i class="fas fa-image text-6xl text-gray-400 mb-4"></i>
                <p class="text-gray-600">画像解析機能は今後実装予定です</p>
            </div>
        </div>
    </div>
    
    <script>
        // グローバル変数
        let blocks = [];
        let settings = {
            outputFormat: 'sdxl',
            model: 'gpt-4'
        };
        
        // タブ切り替え
        function setTab(tab) {
            document.querySelectorAll('[id^="tab-"]').forEach(el => {
                el.classList.remove('border-blue-500', 'text-blue-600');
                el.classList.add('border-transparent');
            });
            document.querySelectorAll('[id^="content-"]').forEach(el => {
                el.classList.add('hidden');
            });
            
            document.getElementById('tab-' + tab).classList.add('border-blue-500', 'text-blue-600');
            document.getElementById('tab-' + tab).classList.remove('border-transparent');
            document.getElementById('content-' + tab).classList.remove('hidden');
        }
        
        // テキスト分解
        async function splitText() {
            const text = document.getElementById('input-text').value;
            if (!text) return;
            
            try {
                const response = await fetch('/api/split', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                const data = await response.json();
                blocks = data.blocks;
                renderBlocks();
            } catch (error) {
                // フォールバック
                const parts = text.split(/[,，.。、]/g).filter(p => p.trim());
                blocks = parts.map((part, i) => ({
                    id: Date.now() + i,
                    en: part.trim(),
                    ja: part.trim(),
                    weight: 1.0,
                    category: 'other'
                }));
                renderBlocks();
            }
        }
        
        // AI色分け
        async function colorizeBlocks() {
            if (blocks.length === 0) return;
            
            try {
                const response = await fetch('/api/categorize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ blocks })
                });
                const data = await response.json();
                blocks = data.blocks;
                renderBlocks();
            } catch (error) {
                // フォールバック
                const categories = ['person', 'appearance', 'clothing', 'pose', 'background', 'quality', 'style', 'other'];
                blocks = blocks.map(block => ({
                    ...block,
                    category: categories[Math.floor(Math.random() * categories.length)]
                }));
                renderBlocks();
            }
        }
        
        // AI生成
        async function generateAI() {
            const text = document.getElementById('input-text').value;
            if (!text) return;
            
            const optimized = 'masterpiece, best quality, ' + text + ', detailed, 8k';
            document.getElementById('input-text').value = optimized;
            await splitText();
        }
        
        // クリア
        function clearAll() {
            document.getElementById('input-text').value = '';
            blocks = [];
            renderBlocks();
        }
        
        // 新しいタグ追加
        function addNewTag(lang) {
            const input = document.getElementById('new-tag-' + lang);
            const value = input.value.trim();
            if (!value) return;
            
            const newBlock = {
                id: Date.now(),
                en: lang === 'en' ? value : value + '_translated',
                ja: lang === 'ja' ? value : value + '_翻訳済み',
                weight: 1.0,
                category: 'other'
            };
            
            blocks.push(newBlock);
            input.value = '';
            renderBlocks();
        }
        
        // ブロックのレンダリング
        function renderBlocks() {
            const enContainer = document.getElementById('blocks-en');
            const jaContainer = document.getElementById('blocks-ja');
            
            enContainer.innerHTML = '';
            jaContainer.innerHTML = '';
            
            blocks.forEach(block => {
                // 英語ブロック
                const enBlock = createBlockElement(block, 'en');
                enContainer.appendChild(enBlock);
                
                // 日本語ブロック
                const jaBlock = createBlockElement(block, 'ja');
                jaContainer.appendChild(jaBlock);
            });
            
            updateFinalPrompt();
        }
        
        // ブロック要素の作成
        function createBlockElement(block, lang) {
            const div = document.createElement('div');
            div.className = `block-card p-3 border-2 rounded-lg mb-2`;
            div.setAttribute('data-category', block.category);
            
            const categoryColors = {
                person: 'bg-yellow-100 border-yellow-400',
                appearance: 'bg-blue-100 border-blue-400',
                clothing: 'bg-pink-100 border-pink-400',
                pose: 'bg-purple-100 border-purple-400',
                background: 'bg-green-100 border-green-400',
                quality: 'bg-orange-100 border-orange-400',
                style: 'bg-yellow-100 border-yellow-500',
                other: 'bg-gray-100 border-gray-400'
            };
            
            div.className += ' ' + (categoryColors[block.category] || categoryColors.other);
            
            div.innerHTML = `
                <div class="flex items-start justify-between gap-2">
                    <div class="flex-1">
                        <div class="cursor-text hover:bg-white/50 px-2 py-1 rounded" 
                             onclick="editBlock(${block.id}, '${lang}')">${block[lang]}</div>
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="changeWeight(${block.id}, 0.05)" class="text-gray-600 hover:text-gray-800">
                            <i class="fas fa-chevron-up text-xs"></i>
                        </button>
                        <span class="text-sm font-mono w-10 text-center">${block.weight.toFixed(2)}</span>
                        <button onclick="changeWeight(${block.id}, -0.05)" class="text-gray-600 hover:text-gray-800">
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <button onclick="deleteBlock(${block.id})" class="text-red-600 hover:text-red-800 ml-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            return div;
        }
        
        // ブロック編集
        function editBlock(id, lang) {
            const block = blocks.find(b => b.id === id);
            if (!block) return;
            
            const newValue = prompt('タグを編集:', block[lang]);
            if (newValue !== null && newValue.trim()) {
                block[lang] = newValue.trim();
                renderBlocks();
            }
        }
        
        // 重み変更
        function changeWeight(id, delta) {
            const block = blocks.find(b => b.id === id);
            if (!block) return;
            
            block.weight = Math.max(0.1, Math.min(2.0, block.weight + delta));
            renderBlocks();
        }
        
        // ブロック削除
        function deleteBlock(id) {
            blocks = blocks.filter(b => b.id !== id);
            renderBlocks();
        }
        
        // 完成プロンプトの更新
        function updateFinalPrompt() {
            const format = document.getElementById('output-format').value;
            let prompt = '';
            
            if (blocks.length > 0) {
                if (format === 'sdxl') {
                    prompt = blocks.map(b => {
                        const tag = b.en;
                        return b.weight !== 1.0 ? `(${tag}:${b.weight.toFixed(2)})` : tag;
                    }).join(', ');
                } else if (format === 'flux') {
                    prompt = blocks.map(b => b.en).join('. ') + '.';
                } else {
                    prompt = blocks.map(b => b.en).join(' ');
                }
            }
            
            document.getElementById('final-prompt').textContent = prompt || 'プロンプトがまだ生成されていません';
            document.getElementById('preview-prompt').textContent = prompt || 'プロンプトなし';
        }
        
        // プロンプトコピー
        function copyPrompt() {
            const text = document.getElementById('final-prompt').textContent;
            navigator.clipboard.writeText(text);
            alert('コピーしました！');
        }
        
        // 画像生成
        async function generateImage() {
            const prompt = document.getElementById('final-prompt').textContent;
            if (!prompt || prompt === 'プロンプトがまだ生成されていません') return;
            
            document.getElementById('generated-image').innerHTML = '<p class="text-gray-600">生成中...</p>';
            
            try {
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                const data = await response.json();
                
                document.getElementById('generated-image').innerHTML = 
                    `<img src="${data.image.url}" alt="Generated" class="w-full rounded-lg shadow-lg">`;
            } catch (error) {
                document.getElementById('generated-image').innerHTML = 
                    '<p class="text-red-600">生成に失敗しました</p>';
            }
        }
        
        // 設定モーダル
        function toggleSettings() {
            alert('設定画面は開発中です');
        }
        
        // イベントリスナー
        document.getElementById('output-format').addEventListener('change', updateFinalPrompt);
    </script>
</body>
</html>