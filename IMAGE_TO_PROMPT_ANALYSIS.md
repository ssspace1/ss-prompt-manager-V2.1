# Image to Prompt 機能統一化 - 現状分析と改修計画

## 📊 現状分析（2025-08-22）

### 🎯 目標
**Image to PromptをText to Promptと完全に同じUI・仕様・体験に統一する**
- 英⇔日双方向タグ編集
- Split to Tags機能
- AIタグ生成
- カテゴリ色分け
- 出力整形
- 画像生成APIへの連動

### 🔍 現在の実装状況

#### Text to Prompt（メインタブ）の実装
1. **タグ編集システム（TagEditor）**
   - 場所: `app-main.js` lines 91-697
   - 機能:
     - 英日双方向編集（ダブルクリックでインライン編集）
     - ドラッグ&ドロップによる順序変更
     - 重み調整（0.1〜2.0、上下矢印ボタン）
     - カテゴリ自動色分け（8カテゴリ）
     - リアルタイム同期更新

2. **Split to Tags機能**
   - 場所: `app-main.js` lines 893-952
   - 機能:
     - 区切り文字（カンマ、改行、ピリオド）での分割
     - 自動正規化（トリム、空白除去）
     - 重複除去
     - AI不使用の高速処理

3. **AI Generate機能**
   - 場所: `app-main.js` lines 1126-1251
   - 機能:
     - OpenRouter API使用
     - 品質タグ自動追加
     - カテゴリ自動推定
     - 英日自動翻訳
     - 差分更新（既存タグ保持）

4. **出力形式**
   - SDXL形式（カンマ区切り、重み付き）
   - Flux形式（自然言語）
   - ImageFX形式（コマンド形式）
   - カスタム形式対応

#### Image to Prompt（画像タブ）の現在の問題点

1. **UIの不一致**
   - ❌ タグエディタが独自実装（renderImageTags）
   - ❌ インライン編集なし（inputフィールドのみ）
   - ❌ ドラッグ&ドロップ未実装
   - ❌ タグカードのレイアウト違い
   - ❌ スクロール非対応（タグが全部見えない）

2. **機能の欠落**
   - ❌ Split to Tags機能なし
   - ❌ AI Generate時のタグ形式解析が不完全
   - ❌ カテゴリ分類ロジックが簡易版
   - ❌ 差分同期なし（全置換のみ）

3. **データ構造の分離**
   - 別々のstate管理（appState.tags vs App.imageState.imageTags）
   - 共通TagEditorシステムの部分的使用のみ
   - 重複コード多数

### 📋 差分詳細リスト

| 機能 | Text to Prompt | Image to Prompt | 差分 |
|------|----------------|-----------------|------|
| **タグ表示** | TagEditor.renderTags() | 部分的にTagEditor使用、独自renderImageTags併存 | 統一必要 |
| **編集方法** | ダブルクリックでインライン編集 | inputフィールド常時表示 | インライン編集追加必要 |
| **ドラッグ&ドロップ** | 完全実装 | 未実装 | 実装必要 |
| **Split to Tags** | あり（区切り文字対応） | なし | 実装必要 |
| **AI Generate** | タグ単位で生成・差分更新 | プロンプト全体生成のみ | タグ解析追加必要 |
| **カテゴリ分類** | 詳細な辞書ベース | 簡易パターンマッチ | 共通化必要 |
| **重み調整UI** | 上下矢印ボタン（コンパクト） | +-ボタン（幅取る） | UI統一必要 |
| **出力整形** | 3形式＋カスタム | 基本3形式のみ | 機能追加必要 |
| **翻訳** | AI/辞書ハイブリッド | 辞書のみ | AI翻訳追加必要 |
| **スクロール** | overflow-x-auto対応 | 非対応 | CSS追加必要 |

## 🎯 改修方針

### Phase 1: 基盤統一（優先度：高）
1. **TagEditorの完全共通化**
   - Image to Prompt専用コードを削除
   - TagEditor.renderTags('image')に完全移行
   - データ構造の統一

2. **UIレイアウト統一**
   - HTMLテンプレートの同一化
   - CSSクラスの共通化
   - スクロール対応追加

### Phase 2: 機能追加（優先度：高）
1. **Split to Tags実装**
   - 画像解析結果を区切り文字で分割
   - タグ正規化処理
   - 重複除去

2. **AI Generate改善**
   - タグ形式での生成
   - 差分更新対応
   - JSONスキーマ厳格化

### Phase 3: 高度な機能（優先度：中）
1. **ドラッグ&ドロップ**
   - タグ順序変更
   - 視覚的フィードバック

2. **AI翻訳統合**
   - OpenRouter API活用
   - キャッシュ機能

### Phase 4: 最適化（優先度：低）
1. **パフォーマンス**
   - 仮想スクロール
   - デバウンス処理

2. **UX改善**
   - アニメーション
   - ショートカットキー

## 🛠️ 実装タスク

### 即座に実行すべきタスク
1. ✅ 現状分析完了
2. 🔄 HTMLテンプレート修正（Image to PromptタブのHTML構造をText to Promptと同一に）
3. ⏳ renderImageTags削除、TagEditor.renderTags('image')への完全移行
4. ⏳ Split to Tags機能の追加
5. ⏳ AI Generateのタグ解析改善

### 実装の優先順位
1. **最優先**: スクロール対応（タグが全部見えない問題）
2. **高**: Split to Tags機能
3. **高**: インライン編集
4. **中**: ドラッグ&ドロップ
5. **低**: アニメーション等のUX改善

## 📝 受け入れ基準（DoD）

- [ ] Image to PromptのタグエディタがText to Promptと完全に同じ見た目・動作
- [ ] Split to Tags機能が画像タブでも動作
- [ ] AI Generateがタグ単位で生成・更新
- [ ] 英⇔日の双方向編集が即座に反映
- [ ] すべてのタグがスクロールで閲覧可能
- [ ] ドラッグ&ドロップでタグ順序変更可能
- [ ] カテゴリ色分けが自動適用
- [ ] 出力形式の切り替えが正常動作
- [ ] コードの重複がない（共通化完了）

## 🚀 次のステップ

1. **HTMLテンプレート修正**から着手
2. **TagEditor完全統合**でコード共通化
3. **Split to Tags実装**で機能パリティ達成
4. **テスト・調整**で品質確保

---
*このドキュメントは実装の進捗に応じて更新される*